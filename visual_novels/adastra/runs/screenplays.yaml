config:
  output_dir: /home/jayckaiser/code/renpy-analyzer/visual_novels/adastra/outputs/screenplays
  state_file: /home/jayckaiser/code/renpy-analyzer/visual_novels/adastra/.earthmover.csv
  log_level: DEBUG
  show_stacktrace: True
  show_graph: False

custom_nodes:
  sources:
    - ['renpy_analyzer.nodes', 'SourceRA']
  operations:
    - ['renpy_analyzer.nodes', 'OperationRA']
  destinations:
    - ['renpy_analyzer.nodes', 'DestinationRA']

anchors:
  adastra_game_dir: &adastra_base_dir /home/jayckaiser/code/renpy-analyzer/visual_novels/adastra/game


sources:
  adastra:
#    file: /home/jayckaiser/code/renpy-analyzer/visual_novels/adastra/outputs/adastra.jsonl
    file: /home/jayckaiser/code/renpy-analyzer/visual_novels/adastra/outputs/adastra_earthmover_nlp.jsonl


transformations:
  filter_base_lines:
    operations:
      - operation: sql_select
        sources:
          - $sources.adastra
        aliases:
          - adastra
        sql: |
            select
                str_split(str_split(file, '/')[-1], '.')[1] as file,
                line_idx,
                has_speaker,
                is_choice,
                is_branch,
                speaker,
                line
            from adastra
            where is_read or is_choice
            order by file, line_idx

  format_screenplay_style1:
    operations:
      - operation: sql_select
        sources:
          - $transformations.filter_base_lines
        aliases:
          - adastra
        sql: |
            select *,
              case
                -- Player/game choice between branches
                when is_choice
                  then format('[{}]', line)
          
                -- Spoken dialogue in branch
                when is_branch and has_speaker
                  then format('{}\n{}', upper(speaker), line)
          
                -- Internal or unspecified narration in branch
                when is_branch and not has_speaker
                  then line
                  
                -- Spoken dialogue
                when has_speaker and not is_branch
                  then format('{}\n{}', upper(speaker), line)
          
                -- Internal or unspecified narration
                when not has_speaker and not is_branch
                  then line
          
                else line
              end as formatted_text,
          
              case
                -- Branch
                when is_branch
                  then 8
          
                -- Non-branch
                else 0
                  
              end as offset,
          
              case
                -- Spoken dialogue in branch
                when is_branch and has_speaker
                  then 10
          
                -- Internal or unspecified narration in branch
                when is_branch and not has_speaker
                  then 8
                  
                -- Spoken dialogue
                when has_speaker and not is_branch
                  then 2
          
                -- Internal or unspecified narration
                when not has_speaker and not is_branch
                  then 0
          
                else 0
              end as wrap_offset
          
            from adastra
            where formatted_text is not null

  format_screenplay_style2:
    operations:
      - operation: sql_select
        sources:
          - $transformations.filter_base_lines
        aliases:
          - adastra
        sql: |
            select *,
              case
                -- Player/game choice between branches
                when is_choice
                  then format('[BRANCH]: {}', line)
          
                -- Spoken dialogue in branch
                when is_branch and has_speaker
                  then format('{}: {}', upper(speaker), line)
          
                -- Internal or unspecified narration in branch
                when is_branch and not has_speaker
                  then line
                  
                -- Spoken dialogue
                when has_speaker and not is_branch
                  then format('{}: {}', upper(speaker), line)
          
                -- Internal or unspecified narration
                when not has_speaker and not is_branch
                  then line
          
                else line
              end as formatted_text,
          
              case
                -- Branch
                when is_branch
                  then 4
          
                -- Non-branch
                else 0
                  
              end as offset,
          
              case
                -- Spoken dialogue in branch
                when is_branch and has_speaker
                  then 8
          
                -- Internal or unspecified narration in branch
                when is_branch and not has_speaker
                  then 4
                  
                -- Spoken dialogue
                when has_speaker and not is_branch
                  then 4
          
                -- Internal or unspecified narration
                when not has_speaker and not is_branch
                  then 0
          
                else 0
              end as wrap_offset
          
            from adastra
            where formatted_text is not null

  format_screenplay_style3:
    operations:
      - operation: sql_select
        sources:
          - $transformations.filter_base_lines
        aliases:
          - adastra
        sql: |
            select *,
              case
                -- Player/game choice between branches
                when is_choice
                  then format('[BRANCH]: {}', line)
          
                -- Spoken dialogue
                when has_speaker or speaker = 'speaker_unspecified'
                  then format('{}\n{}', upper(speaker), line)
          
                else line
              end as formatted_text,
          
              case
                -- Spoken dialogue
                when has_speaker or speaker = 'speaker_unspecified'
                  then 15
          
                else 0        
              end as offset,
          
              case
                -- Spoken dialogue
                when has_speaker or speaker = 'speaker_unspecified'
                  then 15
          
                else 0
              end as wrap_offset
          
            from adastra
            where formatted_text is not null

#      # Add bars separating branches
#      - operation: sql_select
#        sources:
#          - $transformations.format_screenplay_style3
#        aliases:
#          - adastra
#        sql: |
#            select *,
#
#                REPLACE(
#                  case
#                    when not is_branch and lag(is_branch, 1) over (partition by file order by line_idx)
#                      then format('---------------------------------------------------------------------------\n{}', screenplay)
#                    else screenplay
#                  end as screenplay
#                )
#
#            from adastra
#            where screenplay is not null
            

destinations:
#  screenplay_style1:
#    mode: 'screenplay'
#    source: $transformations.format_screenplay_style1
#    text_col: formatted_text
#    screenplay_col: screenplay
#    file_col: file
#    justify: 75
#
#  screenplay_style2:
#    mode: 'screenplay'
#    source: $transformations.format_screenplay_style2
#    text_col: formatted_text
#    screenplay_col: screenplay
#    file_col: file
#    justify: 75

  screenplay_style3:
    mode: 'screenplay'
    source: $transformations.format_screenplay_style3
    text_col: formatted_text
    screenplay_col: screenplay
    file_col: file
    justify: 75