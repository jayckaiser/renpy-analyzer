config:
  output_dir: /home/jayckaiser/code/renpy-analyzer/visual_novels/adastra/outputs
  log_level: DEBUG
  show_stacktrace: True
  show_graph: False

custom_nodes:
  sources:
    - ['renpy_analyzer.nodes', 'SourceRA']
  operations:
    - ['renpy_analyzer.nodes', 'OperationRA']
  destinations:
    - ['renpy_analyzer.nodes', 'DestinationRA']

anchors:
  adastra_game_dir: &adastra_base_dir /home/jayckaiser/code/renpy-analyzer/visual_novels/adastra/game

  default_relplot_args: &relplot_args
    hue: speaker
    kind: line

  default_wordcloud_args: &wordcloud_args
    font_path: /home/jayckaiser/code/renpy-analyzer/visual_novels/adastra/game/RobotoSlab-Medium.ttf
    max_words: 2500
    max_font_size: 30
    mode: RGB
    background_color: black
    repeat: True
    relative_scaling: 0.3
    random_state: 42


sources:
  adastra:
#    file: /home/jayckaiser/code/renpy-analyzer/visual_novels/adastra/outputs/adastra.jsonl
    file: /home/jayckaiser/code/renpy-analyzer/visual_novels/adastra/outputs/adastra_earthmover_nlp.jsonl


transformations:
  lines_per_character:
    operations:
      - operation: sql_select
        sources:
          - $sources.adastra
        aliases:
          - adastra
        sql: |
            select
                str_split(file, '/')[-1] as file,
                speaker,
                count(*) as num_lines
            from adastra
            where is_read
            group by 1, 2
            having num_lines > 10
            order by 1, 2

#  amicus_frequencies:
#    operations:
#      - operation: filter_rows
#        source: $sources.adastra
#        query: "is_read == True and speaker == 'amicus'"
#        behavior: include
#
#      - operation: tfidf_frequencies
#        source: $transformations.amicus_frequencies
#        document_col: content_words
#        frequency_col: frequencies
#        tfidfvectorizer:
#          stop_words: 'english'
#          ngram_range: [1, 1]
#          max_df: 0.3
#          min_df: 5

  neferu_frequencies:
    operations:
      - operation: filter_rows
        source: $sources.adastra
        query: "is_read == True and speaker == 'neferu'"
        behavior: include

      - operation: tfidf_frequencies
        source: $transformations.neferu_frequencies
        document_col: content_words
        frequency_col: frequencies
        tfidfvectorizer:
          stop_words: 'english'
          ngram_range: [ 1, 1 ]
          max_df: 0.3
          min_df: 5

destinations:
  lines_per_character:
    mode: relplot
    source: $transformations.lines_per_character
    relplot:
      <<: *relplot_args
      x: file
      y: num_lines

#  amicus:
#    mode: wordcloud
#    source: $transformations.amicus_frequencies
#    image: /home/jayckaiser/code/renpy-analyzer/visual_novels/adastra/game/images/sprites/amicus/amicus.png
#    frequency_col: frequencies
#    wordcloud:
#      <<: *wordcloud_args
#      contour_width: 1
#      contour_color: white

  neferu:
    mode: wordcloud
    source: $transformations.neferu_frequencies
    image: /home/jayckaiser/code/renpy-analyzer/visual_novels/adastra/game/images/sprites/neferu/neferu.png
    frequency_col: frequencies
    wordcloud:
      <<: *wordcloud_args
      contour_width: 1
      contour_color: white